<!DOCTYPE html>
<html lang=en>
<head>
	<title> · Richard JE Cooke</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="HandheldFriendly" content="True">
	<meta name="viewport" content="width=device-width, initial-scale=1"> <!-- make page size responsive -->

	<link rel="shortcut icon" href="/_media/img/logo.png">
	<!-- Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Comfortaa&family=Mulish&family=Ubuntu+Mono&display=swap" rel="stylesheet">

	<!-- CSS -->
	<link rel="stylesheet" href="/_media/css/main.css">
	<link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">

	<!--
	TODO
	<meta name="description" content="Contents  1. Introduction 2. The final product 3. CSound &amp;amp; Cabbage 4. Pure Data      1. Introduction   This article describes the creation of a prepared piano created digitally and performed in">
	<meta name="keywords" content="pure data,music">
	<meta property="og:type" content="article">
	<meta property="og:title" content="A prepared digital piano in Pure Data">
	<meta property="og:url" content="https://richardcooke.info/en/2019/prepared-digital-piano-in-pure-data/index.html">
	<meta property="og:site_name" content="Richard JE Cooke">
	<meta property="og:description" content="Contents  1. Introduction 2. The final product 3. CSound &amp;amp; Cabbage 4. Pure Data      1. Introduction   This article describes the creation of a prepared piano created digitally and performed in">
	<meta property="og:locale" content="en">
	<meta property="og:image" content="https://richardcooke.info/en/2019/prepared-digital-piano-in-pure-data/1.png">
	<meta property="og:updated_time" content="2019-06-19T13:33:55.888Z">
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="A prepared digital piano in Pure Data">
	<meta name="twitter:description" content="Contents  1. Introduction 2. The final product 3. CSound &amp;amp; Cabbage 4. Pure Data      1. Introduction   This article describes the creation of a prepared piano created digitally and performed in">
	<meta name="twitter:image" content="https://richardcooke.info/en/2019/prepared-digital-piano-in-pure-data/1.png">
	-->

	<!-- rss -->
	<!-- TODO -->

</head>
<!-- avoid flash of unstyled content -->
<body onload="document.body.style.visibility=`visible`;">
<script>document.body.style.visibility=`hidden`;</script><div class="vspacer"></div>
<div class="border_bottom shadow">
	<div class="center_children">
		<div class="gutters ">
			<div>
				<a href="/" class="no_link_styling title_container">
					<img src="/_media/img/logo.png" width="40rem" height="40rem"  class="white_image"></img>
					<h1 class="title">Richard JE Cooke</h1>
				</a>
			</div>
			<div class="flex">
				<div class="hspacer">
					<a href="/articles">Articles</a>
				</div>
				<div class="hspacer">
					<a href="/apps">Apps</a>
				</div>
				<div class="hspacer">
					<a href="/music">Music</a>
				</div>
				<div class="hspacer">
					<a href="/cv">C.V.</a>
				</div>
				<div>
					<a href="/atom.xml">RSS</a>
				</div>
			</div>
		</div>
	</div>
	<div class="vspacer"></div>
</div>
<div class="vspacer"></div>
<div class="full_column post_container">
	<h2 class="post_title">Configuring a new machine with PowerShell</h2>
	<span class="post_date">4 February 2014</span>
	<p>This article will show you everything you need to know to use PowerShell to programmatically setup Windows services and IIS applications on a new machine.  It's aimed at complete beginners and is as concise as possible.</p>
<h2>Why do this in PowerShell?</h2>
<p>I wrote the script discussed in this article to completely automate the configuration of our virtual machines. Whenever a new environment is created for testing or deployment all that needs to be done is to run a script, rather than install and configure everything manually. Why PowerShell? Because it's the Microsoft standard tool for system administration.</p>
<h2>Install PowerShell</h2>
<p>Google the latest version of the Windows Management Framework, download and install it.  <a href="http://www.microsoft.com/en-za/download/details.aspx?id=40855">Version 4 of PowerShell</a> is the latest at the time of writing.</p>
<p><strong>WARNING</strong> Some of the modules available in PowerShell depend on the version of Windows you have, not the version of PowerShell.  If you find a function you are trying to use just isn't working check in the MSDN documentation to see if its module is in your version of Windows.</p>
<h2>Windows PowerShell ISE (integrated scripting environment)</h2>
<p>The ISE is a useful text editor for your scripts and can run them too.</p>
<h3>Hotkeys</h3>
<p>- Ctrl 1 to Ctrl 3 change the arrangement of the script and console windows</p>
<ul>
<li>Ctrl R switches between the script and console windows</li>
</ul>
<p><strong>WARNING</strong> The ISE does not clear the PowerShell session whenever you click run. If you make a change to a script used by another script the change won't be used. This is because all the functions have already been defined in the session. Instead you have to use only one file, or restart the ISE.</p>
<h2>Allow PowerShell to run scripts</h2>
<p>Start a PowerShell command window and run the following command <code>Set-Executionpolicy RemoteSigned</code></p>
<p>This will allow you to run scripts in the current folder by typing <code>./MyScript.ps1</code></p>
<h2>Make some configuration settings</h2>
<p>Let's look at a basic script</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token comment">&lt;#<br>Purpose:<br>    This script configures a machine.<br>#></span><br><br><br><span class="token comment"># The line below ensures we have correct version, it is not just a comment</span><br><span class="token comment">#requires -Version 3.0</span><br><br><span class="token comment">#region Settings</span><br><br><span class="token variable">$folders</span> = @<span class="token punctuation">(</span><br>    <span class="token namespace">[pscustomobject]</span> @<span class="token punctuation">{</span>name=<span class="token string">"Books"</span><span class="token punctuation">;</span> file = <span class="token string">"C:\temp\Books"</span><span class="token punctuation">;</span> user = <span class="token string">"EVERYONE"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token namespace">[pscustomobject]</span> @<span class="token punctuation">{</span>name=<span class="token string">"Sound"</span><span class="token punctuation">;</span> file = <span class="token string">"C:\temp\Sound"</span><span class="token punctuation">;</span> user = <span class="token string">"EVERYONE"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">)</span><br><br><span class="token comment">#endregion</span><br><br>cls<br><span class="token function">Write-Host</span> <span class="token string">"Starting program"</span><br><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$folders</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token function">Write-Host</span> <span class="token variable">$item</span><span class="token punctuation">.</span>file<br><span class="token punctuation">}</span></code></pre>
<ul>
<li>Line 1 shows multi-line comments.</li>
<li>Line 6 shows single line comments.</li>
<li>Line 7 shows an interpreter directive - the script won't run unless PowerShell is the right version.</li>
<li>Lines 9 and 16 define a region that you can minimise in the ISE to keep your script uncluttered.</li>
<li>Line 11 defines a variable. Variables start with $. The @ symbol means the following lines are all one command (otherwise PowerShell thinks one line is one command; there are no semicolon endings). This line also defines an array.  It casts two anonymous dictionaries of three strings to a pscustomerobject.</li>
<li>Line 18 shows that DOS commands are included in PowerShell, and clears the screen.</li>
<li>Line 19 allows you to write to the screen and the next few lines show you a foreach loop.</li>
</ul>
<h2>Put the configuration in a separate file</h2>
<p>Let's put the configuration arrays in a separate file so we can edit them separately later. Make a new script called Configuration.ps1 and add these lines:</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token variable">$version</span> = 1<br><br><span class="token variable">$folders</span> = @<span class="token punctuation">(</span><br>    pscustomobject @<span class="token punctuation">{</span>name=<span class="token string">"Books"</span><span class="token punctuation">;</span> file = <span class="token string">"C:\temp\Books"</span><span class="token punctuation">;</span> user = <span class="token string">"EVERYONE"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    pscustomobject @<span class="token punctuation">{</span>name=<span class="token string">"Sound"</span><span class="token punctuation">;</span> file = <span class="token string">"C:\temp\Sound"</span><span class="token punctuation">;</span> user = <span class="token string">"EVERYONE"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">)</span><br><br><span class="token variable">$windowsServices</span> = @<span class="token punctuation">(</span><br>    pscustomobject @<span class="token punctuation">{</span>name=<span class="token string">"Monitoring Service"</span><span class="token punctuation">;</span>     file = <span class="token string">"C:\temp\Movie\SystemsMonitor.exe"</span><span class="token punctuation">;</span>                  user = <span class="token string">"NetworkService"</span><span class="token punctuation">;</span>         password = <span class="token string">"1gn0red"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">)</span></code></pre>
<p>We can then make a script that uses these settings like so:</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token function">Write-Host</span> <span class="token variable">$version</span><br><span class="token function">Write-Host</span> <span class="token string">"Importing configuration settings"</span><br><span class="token punctuation">.</span> <span class="token variable">$PSScriptRoot</span>\Configuration<span class="token punctuation">.</span>ps1<br><span class="token function">Write-Host</span> <span class="token variable">$version</span></code></pre>
<p><strong>WARNING</strong> Note that line 1 won't work because the variable hasn't been defined yet. PowerShell doesn't look forward through a file - functions and variables must be declared before being used. Line 3 is called dot sourcing. It's as if the other script file had been copied and pasted into that line. It's more neat to make your script libraries into standalone reusable modules, but we'll get to that later.</p>
<h2>Functions and parameters</h2>
<p>Let's look at a basic function and its use:</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token keyword">function</span> <span class="token function">Get-ValueOrUseDefault</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token variable">$default</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$input</span> = <span class="token function">Read-Host</span> <span class="token variable">$message</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$input</span> <span class="token operator">-eq</span> <span class="token variable">$null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token variable">$default</span> <span class="token punctuation">}</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$input</span> <span class="token operator">-eq</span> <span class="token string">""</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token variable">$default</span> <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token variable">$input</span><br><span class="token punctuation">}</span><br><br><span class="token variable">$scheduledTaskUser</span> = <span class="token string">"Richard"</span><br><span class="token variable">$scheduledTaskUser</span> = <span class="token function">Get-ValueOrUseDefault</span> <span class="token punctuation">(</span><span class="token string">"Enter the user to run scheduled tasks as, or push enter to use the default value '"</span> <span class="token operator">+</span> <span class="token variable">$scheduledTaskUser</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>scheduledTaskUser<span class="token punctuation">)</span></code></pre>
<p>Functions work as you'd expect except for a couple of surprises:</p>
<ul>
<li>Line 1: PowerShell expects functions to start with a verb from the list found by running Get-Verb.  It won't error but will warn you.</li>
<li>Line 4: Comparison operators are -eq for =, -ne for &lt;&gt;, -gt for &gt;, and so on. Null, true, and false are represented by $null, $true, and $false.</li>
<li>Line 10: Functions are not called with parameters in brackets, nor separated by commas.  Parameters are separated only by whitespace. Brackets are used to wrap something that contains spaces into one parameter.</li>
<li>Parameters are passed by value unless you preceed the formal and actual parameters by ref. If the function can't find a variable in the parameter list it will create a global variable (like Javascript if you create a variable without using 'var').</li>
</ul>
<h2>Modules &amp; logging</h2>
<p>PowerShell groups code for reuse by making modules (similar to packages or assemblies in other languages). Here's how to import and use a logging module. Download and unzip this logging <a href="http://gallery.technet.microsoft.com/scriptcenter/PSLog-Send-messages-to-a-db389927">module</a> into a subfolder called PSLog beneath your script. Notice that the folder contains a module manifest file and a code file.  To make your own module just copy this folder and rename the files and manifest information. To import and use the module use this code:</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token function">Write-Host</span> <span class="token string">"Creating log file"</span><br><span class="token function">Import-Module</span> <span class="token variable">$PSScriptRoot</span>\PSLog<br><span class="token function">Start-Log</span> <span class="token operator">-</span>LogName PrepareMachineForDTS <span class="token operator">-</span>LogPath <span class="token variable">$PSScriptRoot</span> <span class="token operator">-</span>Level All<br><span class="token function">Write-Host</span> <span class="token string">"I'm in a file and on the screen"</span></code></pre>
<p>Line 1 will just write to the screen.
The module is then imported in line 2 ($PSScriptRoot is the folder the script is in).
Line 3 activates it to create a log file and writes further Write-Host output to the file as well as the screen.</p>
<h2>Calling DOS commands</h2>
<p>If you're not using Windows 8 or the server version you'll find many missing PowerShell commands and you'll have to rely on the standard DOS management applications.  Calling them with the correct parameters can be tricky. PowerShell is usually pretty clever and correctly surrounds a variable's content with &quot; &quot; when passing it as parameter.  But if it doesn't work put the whole command in a string and run it like this:</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token variable">$command</span> = <span class="token string">"cmd /c '"</span> <span class="token operator">+</span> <span class="token string">"schtasks /create /tn `""</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"`" /TR  `""</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>file <span class="token operator">+</span> <span class="token string">"`" /RU "</span> <span class="token operator">+</span> <span class="token variable">$scheduledTaskUser</span> <span class="token operator">+</span> <span class="token string">" /RP "</span> <span class="token operator">+</span> <span class="token variable">$scheduledTaskUserPassword</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>schedule <span class="token operator">+</span> <span class="token string">"'"</span><br><span class="token variable">$output</span> = <span class="token function">Invoke-Expression</span> <span class="token variable">$command</span><br><span class="token function">Write-Host</span> <span class="token variable">$output</span></code></pre>
<h2>A full script with useful functions</h2>
<p>That's about it. We've covered the basics of PowerShell and all the suprises for a novice user. The code below gives you a lot of useful functions to create folders, share folders on the network, create IIS applications, create scheduled tasks, and create Windows services. It's quite simple but if you have questions please ask them in a comment at the bottom of this page.</p>
<pre class="language-powershell"><code class="language-powershell"><span class="token variable">$folders</span>  = @<span class="token punctuation">(</span><br>    pscustomobject @<span class="token punctuation">{</span>file = <span class="token string">"C:\temp\movie"</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    pscustomobject @<span class="token punctuation">{</span>file = <span class="token string">"C:\temp\sound"</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">)</span><br><br><span class="token variable">$sharedFolders</span> = @<span class="token punctuation">(</span><br>    pscustomobject @<span class="token punctuation">{</span>name=<span class="token string">"movie"</span><span class="token punctuation">;</span> file = <span class="token string">"C:\movie"</span><span class="token punctuation">;</span> user = <span class="token string">"EVERYONE"</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    pscustomobject @<span class="token punctuation">{</span>name=<span class="token string">"sound"</span><span class="token punctuation">;</span> file = <span class="token string">"C:\temp\sound"</span><span class="token punctuation">;</span> user = <span class="token string">"EVERYONE"</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">)</span><br><br><span class="token variable">$scheduledTasks</span> = @<span class="token punctuation">(</span><br>    pscustomobject @<span class="token punctuation">{</span>name=<span class="token string">"Run movies"</span><span class="token punctuation">;</span> file = <span class="token string">"C:\temp\movie\Go.bat"</span><span class="token punctuation">;</span>  enabled = <span class="token boolean">$true</span><span class="token punctuation">;</span> schedule=<span class="token string">" /ST 19:00 /SC DAILY "</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">)</span><br><br><span class="token variable">$windowsServices</span> = @<span class="token punctuation">(</span><br>    pscustomobject @<span class="token punctuation">{</span>name=<span class="token string">"Monitor movie"</span><span class="token punctuation">;</span>     file = <span class="token string">"C:\temp\movie"</span><span class="token punctuation">;</span> user = <span class="token string">"NetworkService"</span><span class="token punctuation">;</span> password = <span class="token string">"1gn0red"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">)</span><br><br><span class="token variable">$virtualDirectories</span> = @<span class="token punctuation">(</span><br>    pscustomobject @<span class="token punctuation">{</span>name=<span class="token string">"MovieSite"</span><span class="token punctuation">;</span> file=<span class="token string">"C:\temp\movie\webapp"</span><span class="token punctuation">;</span> user=<span class="token string">"NetworkService"</span><span class="token punctuation">;</span> password = <span class="token string">"1gn0red"</span><span class="token punctuation">;</span>   authentication=<span class="token string">"Windows"</span>          <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">)</span><br><br><span class="token comment"># The line below ensures we have correct version, it is not just a comment</span><br><span class="token comment">#requires -Version 3.0</span><br><br><span class="token comment">#region Functions</span><br><span class="token keyword">function</span> <span class="token function">Get-ParentFolder</span><span class="token punctuation">(</span><span class="token variable">$folder</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">Split-Path</span> <span class="token operator">-</span>parent <span class="token variable">$folder</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Confirm-WindowsServiceExists</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Get-Service</span> <span class="token variable">$name</span> <span class="token operator">-</span>ErrorAction SilentlyContinue<span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">$true</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token boolean">$false</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Remove-WindowsServiceIfItExists</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$exists</span> = <span class="token function">Confirm-WindowsServiceExists</span> <span class="token variable">$name</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exists</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token function">Write-Host</span> <span class="token string">"Remove Windows service - "</span> <span class="token variable">$name</span><br>        <span class="token variable">$output</span> = <span class="token punctuation">(</span><span class="token function">sc</span><span class="token punctuation">.</span>exe delete <span class="token variable">$name</span><span class="token punctuation">)</span><br>        <span class="token function">Write-Host</span> <span class="token variable">$output</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Confirm-ScheduledTaskExists</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    schtasks <span class="token operator">/</span>query <span class="token operator">/</span>TN <span class="token variable">$name</span> 2>&amp;1>null       <span class="token comment">#hide error and standard output from displaying</span><br>    <span class="token keyword">return</span> <span class="token variable">$LastExitCode</span> <span class="token operator">-eq</span> 0       <span class="token comment">#if task exists exit code won't be an error</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Remove-ScheduledTaskIfItExists</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$exists</span> = <span class="token function">Confirm-ScheduledTaskExists</span> <span class="token variable">$name</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exists</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$output</span> = <span class="token punctuation">(</span>schtasks <span class="token operator">/</span>delete <span class="token operator">/</span>f <span class="token operator">/</span>tn <span class="token variable">$name</span><span class="token punctuation">)</span>  <span class="token comment">#/f = suppress confirmation message so it can delete without user input</span><br>        <span class="token function">Write-Host</span> <span class="token variable">$output</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Initialize-Logging</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$parentFolder</span> = <span class="token function">Get-Parent</span><span class="token operator">-</span>Folder <span class="token variable">$PSScriptRoot</span><br>    <span class="token function">Import-Module</span> <span class="token variable">$parentFolder</span>\PSLog       <span class="token comment"># allows us to write a log file of this machine setup.  sourced from: http://gallery.technet.microsoft.com/scriptcenter/PSLog-Send-messages-to-a-db389927</span><br>    <span class="token function">Start-Log</span> <span class="token operator">-</span>LogName PrepareMachineForDTS <span class="token operator">-</span>LogPath <span class="token variable">$parentFolder</span> <span class="token operator">-</span>Level All<br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Protect-Password</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token variable">$password</span> <span class="token punctuation">|</span> <span class="token function">ConvertTo-SecureString</span> <span class="token operator">-</span>asPlainText <span class="token operator">-</span>Force<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Add-WindowsServices</span><span class="token punctuation">(</span><span class="token variable">$windowsServices</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token function">Write-Host</span> <span class="token string">"Creating Windows services"</span><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$windowsServices</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token function">Write-Host</span> <span class="token string">"Adding Windows service - "</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name<br>        <span class="token variable">$securePassword</span> = <span class="token function">Protect-Password</span> <span class="token variable">$item</span><span class="token punctuation">.</span>password<br>        <span class="token variable">$user</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Management<span class="token punctuation">.</span>Automation<span class="token punctuation">.</span>PSCredential <span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token variable">$securePassword</span> <span class="token punctuation">)</span><br>        <span class="token function">New-Service</span> <span class="token operator">-</span>name <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">-</span>binaryPathName <span class="token variable">$item</span><span class="token punctuation">.</span>file <span class="token operator">-</span>credential <span class="token variable">$user</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Add-ScheduledTasks</span><span class="token punctuation">(</span><span class="token variable">$scheduledTaskUser</span><span class="token punctuation">,</span> <span class="token variable">$scheduledTaskUserPassword</span><span class="token punctuation">,</span> <span class="token variable">$scheduledTasks</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token function">Write-Host</span> <span class="token string">"Creating scheduled tasks"</span><br><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$scheduledTasks</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$command</span> = <span class="token string">"cmd /c '"</span> <span class="token operator">+</span> <span class="token string">"schtasks /create /tn `""</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"`" /TR  `""</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>file <span class="token operator">+</span> <span class="token string">"`" /RU "</span> <span class="token operator">+</span> <span class="token variable">$scheduledTaskUser</span> <span class="token operator">+</span> <span class="token string">" /RP "</span> <span class="token operator">+</span> <span class="token variable">$scheduledTaskUserPassword</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>schedule <span class="token operator">+</span> <span class="token string">"'"</span><br>        <span class="token variable">$command</span><br>        <span class="token variable">$output</span> = <span class="token function">Invoke-Expression</span> <span class="token variable">$command</span><br>        <span class="token function">Write-Host</span> <span class="token variable">$output</span><br><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">.</span>enabled <span class="token operator">-eq</span> <span class="token boolean">$true</span><span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">continue</span><br>        <span class="token punctuation">}</span><br>        <span class="token variable">$command</span> = <span class="token string">"schtasks /change /tn `""</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"`" /DISABLE"</span><br>        <span class="token variable">$command</span><br>        <span class="token variable">$output</span> = <span class="token function">Invoke-Expression</span> <span class="token variable">$command</span><br>        <span class="token function">Write-Host</span> <span class="token variable">$output</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Remove-ScheduledTasks</span><span class="token punctuation">(</span><span class="token variable">$scheduledTasks</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token function">Write-Host</span> <span class="token string">"Deleting scheduled tasks if they exist"</span><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$scheduledTasks</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token function">Remove-ScheduledTaskIfItExists</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Remove-WindowsServices</span><span class="token punctuation">(</span><span class="token variable">$services</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token function">Write-Host</span> <span class="token string">"Deleting Windows services if they exist"</span><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$services</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token function">Remove-WindowsServiceIfItExists</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Get-ValueOrUseDefault</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token variable">$default</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$input</span> = <span class="token function">Read-Host</span> <span class="token variable">$message</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$input</span> <span class="token operator">-eq</span> <span class="token variable">$null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token variable">$default</span> <span class="token punctuation">}</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$input</span> <span class="token operator">-eq</span> <span class="token string">""</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token variable">$default</span> <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token variable">$input</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Add-AppPool</span><span class="token punctuation">(</span><span class="token variable">$virtualDirectory</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token function">Write-Host</span> <span class="token string">"Creating IIS app pool - "</span> <span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>name<br>    <span class="token variable">$poolName</span> = <span class="token string">"IIS:\AppPools\"</span> <span class="token operator">+</span> <span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>name<br>    <span class="token variable">$pool</span> = <span class="token function">New-Item</span> <span class="token variable">$poolName</span><br>    <span class="token variable">$pool</span><span class="token punctuation">.</span>processModel<span class="token punctuation">.</span>userName = <span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>user<br>    <span class="token variable">$pool</span><span class="token punctuation">.</span>processModel<span class="token punctuation">.</span>password = <span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>password<br>    <span class="token variable">$pool</span><span class="token punctuation">.</span>processModel<span class="token punctuation">.</span>identityType = <span class="token string">"SpecificUser"</span><br>    <span class="token variable">$pool</span><span class="token punctuation">.</span>processModel<span class="token punctuation">.</span>idleTimeout = TimeSpan <span class="token string">"0.00:00:00"</span><br>    <span class="token variable">$pool</span><span class="token punctuation">.</span>managedRuntimeVersion = <span class="token string">"4.0"</span><br>    <span class="token variable">$pool</span><span class="token punctuation">.</span>recycling<span class="token punctuation">.</span>periodicRestart<span class="token punctuation">.</span>time = TimeSpan <span class="token string">"00:00:00"</span><br>    <span class="token variable">$pool</span> <span class="token punctuation">|</span> <span class="token function">Set-Item</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Add-VirtualDirectory</span><span class="token punctuation">(</span><span class="token variable">$virtualDirectory</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token function">Write-Host</span> <span class="token string">"Creating IIS virtual directory - "</span> <span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>name<br>    <span class="token variable">$name</span> = <span class="token string">"IIS:\Sites\Default Web Site\"</span> <span class="token operator">+</span> <span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>name<br>    <span class="token function">New-Item</span> <span class="token variable">$name</span> <span class="token operator">-</span><span class="token function">Type</span> Application <span class="token operator">-</span>physicalPath <span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>file<br>    <span class="token function">Set-ItemProperty</span> <span class="token variable">$name</span> <span class="token operator">-</span>Name applicationPool <span class="token operator">-</span>Value <span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>name<br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Add-WindowsAuthenticationToAppIfNecessary</span><span class="token punctuation">(</span><span class="token variable">$virtualDirectory</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>authentication <span class="token operator">-ne</span> <span class="token string">"Windows"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br>    <span class="token function">Write-Host</span> <span class="token string">"Setting Windows authentication for IIS app - "</span> <span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>name<br>    <span class="token variable">$command</span> = <span class="token variable">$env</span>:SystemRoot <span class="token operator">+</span> <span class="token string">"\system32\inetsrv\AppCmd.exe set config `"Default Web Site/"</span><span class="token operator">+</span><span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>name+<span class="token string">"`" -section:system.webServer/security/authentication/anonymousAuthentication /enabled:`"False`" /commit:apphost"</span><br>    <span class="token function">Write-Host</span> <span class="token variable">$command</span><br>    <span class="token function">Invoke-Expression</span> <span class="token variable">$command</span><br><br>    <span class="token variable">$command</span> = <span class="token variable">$env</span>:SystemRoot <span class="token operator">+</span> <span class="token string">"\system32\inetsrv\AppCmd.exe set config `"Default Web Site/"</span><span class="token operator">+</span><span class="token variable">$virtualDirectory</span><span class="token punctuation">.</span>name+<span class="token string">"`" -section:system.webServer/security/authentication/windowsAuthentication /enabled:`"True`" /commit:apphost"</span><br>    <span class="token function">Write-Host</span> <span class="token variable">$command</span><br>    <span class="token function">Invoke-Expression</span> <span class="token variable">$command</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Add-VirtualDirectories</span><span class="token punctuation">(</span><span class="token variable">$virtualDirectories</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    C:\Windows\system32\inetsrv\AppCmd<span class="token punctuation">.</span>exe unlock config  <span class="token operator">/</span>section:security/authentication/anonymousAuthentication <span class="token comment"># allow us to make changed to authentication types of apps</span><br>    C:\Windows\system32\inetsrv\AppCmd<span class="token punctuation">.</span>exe unlock config  <span class="token operator">/</span>section:security/authentication/windowsAuthentication   <span class="token comment"># allow us to make changed to authentication types of apps</span><br><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$virtualDirectory</span> in <span class="token variable">$virtualDirectories</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token function">Add-AppPool</span> <span class="token variable">$virtualDirectory</span><br>        <span class="token function">Add-VirtualDirectory</span> <span class="token variable">$virtualDirectory</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Remove-VirtualDirectories</span><span class="token punctuation">(</span><span class="token variable">$virtualDirectories</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$virtualDirectories</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$pool</span> = <span class="token string">"IIS:\AppPools\"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name<br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token variable">$pool</span><span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token function">Write-Host</span> <span class="token string">"Removing IIS app pool - "</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name<br>            <span class="token function">Remove-Item</span> <span class="token variable">$pool</span> <span class="token operator">-</span>Force <span class="token operator">-</span>Recurse<br>        <span class="token punctuation">}</span><br><br>        <span class="token variable">$exists</span> = <span class="token function">Confirm-VirtualDirectoryExists</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name<br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exists</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span> <span class="token operator">-or</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">-eq</span> <span class="token string">""</span> <span class="token operator">-or</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">-eq</span> <span class="token variable">$null</span><span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">continue</span><br>        <span class="token punctuation">}</span><br>        <span class="token function">Write-Host</span> <span class="token string">"Removing IIS virtual directory - "</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name<br>        <span class="token variable">$parameter</span> = <span class="token string">"IIS:\Sites\Default Web Site\"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name<br>        <span class="token function">Remove-Item</span> <span class="token variable">$parameter</span> <span class="token operator">-</span>Recurse<br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Confirm-VirtualDirectoryExists</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$parameter</span> = <span class="token string">"IIS:\Sites\Default Web Site\"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name<br>    <span class="token function">Get-Item</span> <span class="token variable">$parameter</span> <span class="token operator">-</span>ErrorAction SilentlyContinue<br>    <span class="token keyword">return</span> <span class="token punctuation">(</span>$?<span class="token punctuation">)</span> <span class="token comment">#if last command was successful return true</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Get-WindowsServiceUsers</span><span class="token punctuation">(</span><span class="token variable">$windowsServices</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$windowsServices</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$message</span> =   <span class="token string">"Enter the user to run the Windows service '"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"' as, or push enter to use the default value '"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>user <span class="token operator">+</span> <span class="token string">"'"</span><br>        <span class="token variable">$item</span><span class="token punctuation">.</span>user = <span class="token function">Get-ValueOrUseDefault</span> <span class="token variable">$message</span> <span class="token variable">$item</span><span class="token punctuation">.</span>user<br>        <span class="token function">Write-Host</span> <span class="token string">""</span><br><br>        <span class="token variable">$message</span> =   <span class="token string">"Enter the password for this user, or push enter to use the default value '"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>password <span class="token operator">+</span> <span class="token string">"'"</span><br>        <span class="token variable">$item</span><span class="token punctuation">.</span>password = <span class="token function">Get-ValueOrUseDefault</span> <span class="token variable">$message</span> <span class="token variable">$item</span><span class="token punctuation">.</span>password<br>        <span class="token function">Write-Host</span> <span class="token string">""</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Get-IisUsers</span><span class="token punctuation">(</span><span class="token variable">$virtualDirectories</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$virtualDirectories</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$message</span> =   <span class="token string">"Enter the user to run the IIS app '"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"' as, or push enter to use the default value '"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>user <span class="token operator">+</span> <span class="token string">"'"</span><br>        <span class="token variable">$item</span><span class="token punctuation">.</span>user = <span class="token function">Get-ValueOrUseDefault</span> <span class="token variable">$message</span> <span class="token variable">$item</span><span class="token punctuation">.</span>user<br>        <span class="token function">Write-Host</span> <span class="token string">""</span><br><br>        <span class="token variable">$message</span> =   <span class="token string">"Enter the password for this user, or push enter to use the default value '"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>password <span class="token operator">+</span> <span class="token string">"'"</span><br>        <span class="token variable">$item</span><span class="token punctuation">.</span>password = <span class="token function">Get-ValueOrUseDefault</span> <span class="token variable">$message</span> <span class="token variable">$item</span><span class="token punctuation">.</span>password<br>        <span class="token function">Write-Host</span> <span class="token string">""</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Add-FolderIfItDoesNotExist</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$folderExists</span> = <span class="token function">Test-Path</span> <span class="token operator">-</span>Path <span class="token variable">$path</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$folderExists</span> <span class="token operator">-eq</span> <span class="token boolean">$false</span><span class="token punctuation">)</span> <span class="token comment"># leave folder alone if it exists</span><br>    <span class="token punctuation">{</span><br>        <span class="token function">Write-Host</span> <span class="token string">"Adding new folder "</span> <span class="token variable">$path</span><br>        <span class="token variable">$output</span> = <span class="token function">New-Item</span> <span class="token operator">-</span>ItemType Directory <span class="token operator">-</span>Path <span class="token variable">$path</span><br>        <span class="token function">Write-Host</span> <span class="token variable">$output</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Add-Folders</span><span class="token punctuation">(</span><span class="token variable">$folders</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$folders</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token function">Add-FolderIfItDoesNotExist</span> <span class="token variable">$item</span><span class="token punctuation">.</span>file<br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Add-SharedFolders</span><span class="token punctuation">(</span><span class="token variable">$sharedFolders</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token function">Write-Host</span> <span class="token string">"Adding folders shared on network"</span><br><br>    <span class="token variable">$share</span> = WMICLASS <span class="token string">"WIN32_Share"</span><br><br>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$item</span> in <span class="token variable">$sharedFolders</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token function">Add-FolderIfItDoesNotExist</span> <span class="token variable">$item</span><span class="token punctuation">.</span>file<br><br>        <span class="token variable">$command</span> = <span class="token string">"(Get-WmiObject -Class Win32_Share -ComputerName . -Filter `"Name='"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"'`")"</span><br>        <span class="token variable">$shareExists</span> = <span class="token function">Invoke-Expression</span> <span class="token variable">$command</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$shareExists</span> <span class="token operator">-ne</span>  <span class="token variable">$null</span><span class="token punctuation">)</span>  <span class="token comment"># remove share if it exists, in case it points to the wrong folder</span><br>        <span class="token punctuation">{</span><br>            <span class="token function">Write-Host</span> <span class="token string">"Deleting network share - "</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name<br>            <span class="token variable">$command</span> = <span class="token string">"(Get-WmiObject -Class Win32_Share -ComputerName . -Filter `"Name='"</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"'`").InvokeMethod(`"Delete`",`<span class="token variable">$null</span>)"</span><br>            <span class="token variable">$command</span><br>            <span class="token variable">$output</span> = <span class="token function">Invoke-Expression</span> <span class="token variable">$command</span><br>            <span class="token function">Write-Host</span> <span class="token variable">$output</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token function">Write-Host</span> <span class="token string">"Adding network share - "</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name<br>        <span class="token comment">#$output = $share.Create($item.file, $item.name, 0)  # the powershell way of doing it doesn't grant rights</span><br>        <span class="token variable">$command</span> = <span class="token string">"cmd /c ' net share `""</span> <span class="token operator">+</span> <span class="token variable">$item</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"`"=`""</span><span class="token operator">+</span><span class="token variable">$item</span><span class="token punctuation">.</span>file+<span class="token string">"`" /GRANT:"</span><span class="token operator">+</span><span class="token variable">$item</span><span class="token punctuation">.</span>user+<span class="token string">",FULL'"</span><br>        <span class="token variable">$output</span> = <span class="token function">Invoke-Expression</span> <span class="token variable">$command</span><br>        <span class="token function">Write-Host</span> <span class="token variable">$output</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Open-FireWallPort</span><br><span class="token punctuation">{</span><br>    <span class="token function">Write-Host</span> <span class="token string">"Opening firewall port 8085 for TCP on the domain only."</span><br>    <span class="token variable">$port</span> = <span class="token function">New-Object</span> <span class="token operator">-</span>ComObject HNetCfg<span class="token punctuation">.</span>FWOpenPort<br>    <span class="token variable">$port</span><span class="token punctuation">.</span>Port = 8085<br>    <span class="token variable">$port</span><span class="token punctuation">.</span>Name = <span class="token string">'Movie port has been opened'</span><br>    <span class="token variable">$port</span><span class="token punctuation">.</span>Enabled = <span class="token boolean">$true</span><br><br>    <span class="token variable">$fwMgr</span> = <span class="token function">New-Object</span> <span class="token operator">-</span>ComObject HNetCfg<span class="token punctuation">.</span>FwMgr<br>    <span class="token variable">$profile</span>=<span class="token variable">$fwMgr</span><span class="token punctuation">.</span>LocalPolicy<span class="token punctuation">.</span>GetProfileByType<span class="token punctuation">(</span>0<span class="token punctuation">)</span>  <span class="token comment">#domain profile only</span><br>    <span class="token variable">$profile</span><span class="token punctuation">.</span>GloballyOpenPorts<span class="token punctuation">.</span>Add<span class="token punctuation">(</span><span class="token variable">$port</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">#endregion</span><br><br>cls<br><span class="token function">Write-Host</span> <span class="token string">"Starting program"</span><br><br><span class="token function">Write-Host</span> <span class="token string">"Creating log file"</span><br><span class="token function">Import-Module</span> <span class="token variable">$PSScriptRoot</span>\PSLog       <span class="token comment"># allows us to write a log file of this machine setup.  sourced from: http://gallery.technet.microsoft.com/scriptcenter/PSLog-Send-messages-to-a-db389927</span><br><span class="token function">Start-Log</span> <span class="token operator">-</span>LogName PrepareMachineForDTS <span class="token operator">-</span>LogPath <span class="token variable">$PSScriptRoot</span> <span class="token operator">-</span>Level All<br><span class="token function">Write-Host</span> <span class="token string">"___________________________________________________"</span><br><br><span class="token variable">$scheduledTaskUser</span> = <span class="token string">"NetworkService"</span><br><span class="token variable">$scheduledTaskUserPassword</span> = <span class="token string">"1gn0r3d"</span><br><br><span class="token function">Write-Host</span> <span class="token string">"Importing PowerShell IIS functions"</span><br><span class="token function">Import-Module</span> WebAdministration<br><br><span class="token function">Write-Host</span> <span class="token string">"Getting all settings needed from the user"</span><br><span class="token function">Get-WindowsServiceUsers</span> <span class="token variable">$windowsServices</span><br><span class="token function">Get-IisUsers</span><span class="token punctuation">(</span><span class="token variable">$virtualDirectories</span><span class="token punctuation">)</span><br><span class="token variable">$scheduledTaskUser</span> = <span class="token function">Get-ValueOrUseDefault</span> <span class="token punctuation">(</span><span class="token string">"Enter the user to run scheduled tasks as, or push enter to use the default value '"</span> <span class="token operator">+</span> <span class="token variable">$scheduledTaskUser</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>scheduledTaskUser<span class="token punctuation">)</span><br><span class="token variable">$scheduledTaskUserPassword</span> = <span class="token function">Get-ValueOrUseDefault</span> <span class="token punctuation">(</span><span class="token string">"Enter the password for this user, or push enter to use the default value '"</span> <span class="token operator">+</span> <span class="token variable">$scheduledTaskUserPassword</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>scheduledTaskUserPassword<span class="token punctuation">)</span><br><br><span class="token function">Open-FireWallPort</span><br><br><span class="token function">Add-Folders</span> <span class="token variable">$folders</span><br><span class="token function">Add-SharedFolders</span> <span class="token variable">$sharedFolders</span><br><br><span class="token function">Remove-ScheduledTasks</span> <span class="token variable">$scheduledTasks</span><br><span class="token function">Add-ScheduledTasks</span> <span class="token variable">$scheduledTaskUser</span> <span class="token variable">$scheduledTaskUserPassword</span> <span class="token variable">$scheduledTasks</span><br><br><span class="token function">Remove-WindowsServices</span> <span class="token variable">$windowsServices</span><br><span class="token function">Add-WindowsServices</span> <span class="token variable">$windowsServices</span><br><br><span class="token function">Remove-VirtualDirectories</span> <span class="token variable">$virtualDirectories</span><br><span class="token function">Add-VirtualDirectories</span> <span class="token variable">$virtualDirectories</span><br><br><span class="token function">Write-Host</span> <span class="token string">"Closing log file"</span><br><span class="token function">Stop-Log</span><br><span class="token function">Write-Host</span> <span class="token string">"Log closed. Program finished"</span><br><br> <br><br><span class="token comment"># The line below ensures we have correct version, it is not just a comment</span><br><span class="token comment">#requires -Version 3.0</span><br><br><span class="token comment">#region Settings</span><br><br><span class="token variable">$apiSourceFolder</span> = <span class="token string">".\src\WebAPI\*"</span><br><span class="token variable">$apiDeploymentFolder</span> = <span class="token string">"\\10.10.10.30\Web.Api.V1.Dev"</span><br><span class="token variable">$configFilename</span> = <span class="token variable">$apiDeploymentFolder</span> <span class="token operator">+</span> <span class="token string">"\Web.config"</span><br><br><span class="token comment">#endregion</span><br><br>cls<br><span class="token function">Write-Host</span> <span class="token string">"Starting program"</span><br><br><span class="token function">Write-Host</span> <span class="token string">"Copy contents of web api folder to dev"</span><br><span class="token function">Copy-Item</span> <span class="token variable">$apiSourceFolder</span> <span class="token variable">$apiDeploymentFolder</span> <span class="token operator">-</span>recurse <span class="token operator">-</span>force<br><br><span class="token function">Write-Host</span> <span class="token string">"Change dev config file"</span><br><span class="token punctuation">(</span><span class="token function">Get-Content</span> <span class="token variable">$configFilename</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'connectionString="Dsn=DEV64"'</span><span class="token punctuation">,</span><span class="token string">'connectionString="Dsn=CLB-DEV"'</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Set-Content</span> <span class="token variable">$configFilename</span><br><br><span class="token function">Write-Host</span> <span class="token string">"Finished"</span></code></pre>

</div>
<div class="vspacer"></div>
<div class="vspacer"></div>
</body>
</html>